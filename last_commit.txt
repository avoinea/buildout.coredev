Repository: plone.restapi


Branch: refs/heads/master
Date: 2020-02-20T08:54:28+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/79d94e63d1edb8e41297776dd6555eb7da367e0e

fullobjects qs is missing in response batch links in batching operations (#869)

Files changed:
A news/868.bugfix
M src/plone/restapi/batching.py
M src/plone/restapi/tests/test_batching.py

b'diff --git a/news/868.bugfix b/news/868.bugfix\nnew file mode 100644\nindex 00000000..5197c835\n--- /dev/null\n+++ b/news/868.bugfix\n@@ -0,0 +1,2 @@\n+fullobjects qs is missing in response batch links in batching operations\n+[sneridagh]\ndiff --git a/src/plone/restapi/batching.py b/src/plone/restapi/batching.py\nindex 1dee04e1..e612f9a2 100644\n--- a/src/plone/restapi/batching.py\n+++ b/src/plone/restapi/batching.py\n@@ -111,7 +111,7 @@ def _url_with_params(self, params):\n         and add or update some query string parameters in it.\n         """\n         url = self.request["ACTUAL_URL"]\n-        qs_params = parse_qsl(self.request["QUERY_STRING"])\n+        qs_params = parse_qsl(self.request["QUERY_STRING"], keep_blank_values=1)\n \n         # Take care to preserve list-like query string arguments (same QS\n         # param repeated multiple times). In other words, don\'t turn the\ndiff --git a/src/plone/restapi/tests/test_batching.py b/src/plone/restapi/tests/test_batching.py\nindex 006511a7..6251fdfe 100644\n--- a/src/plone/restapi/tests/test_batching.py\n+++ b/src/plone/restapi/tests/test_batching.py\n@@ -1,5 +1,4 @@\n # -*- coding: utf-8 -*-\n-from DateTime import DateTime\n from plone.app.testing import setRoles\n from plone.app.testing import SITE_OWNER_NAME\n from plone.app.testing import SITE_OWNER_PASSWORD\n@@ -44,9 +43,6 @@ def _create_doc(self, container, number):\n             u"DXTestDocument",\n             id="doc-%s" % str(number + 1),\n             title=u"Document %s" % str(number + 1),\n-            created=DateTime(1975, 1, 1, 0, 0),\n-            effective=DateTime(2015, 1, 1, 0, 0),\n-            expires=DateTime(2020, 1, 1, 0, 0),\n         )\n \n \n@@ -252,6 +248,24 @@ def test_batching_links_omitted_if_resulset_fits_in_single_batch(self):\n         response = self.api_session.get("/folder?b_size=100")\n         self.assertNotIn("batching", list(response.json()))\n \n+    def test_contains_batching_links_using_fullobjects(self):\n+        # Fetch the second page of the batch using fullobjects\n+        response = self.api_session.get("/folder?b_start=2&b_size=2&fullobjects")\n+\n+        # Batch info in response should contain appropriate batching links\n+        batch_info = response.json()["batching"]\n+\n+        self.assertDictEqual(\n+            {\n+                u"@id": self.portal_url + "/folder?b_start=2&b_size=2&fullobjects",\n+                u"first": self.portal_url + "/folder?b_start=0&b_size=2&fullobjects=",\n+                u"next": self.portal_url + "/folder?b_start=4&b_size=2&fullobjects=",\n+                u"prev": self.portal_url + "/folder?b_start=0&b_size=2&fullobjects=",\n+                u"last": self.portal_url + "/folder?b_start=4&b_size=2&fullobjects=",\n+            },\n+            batch_info,\n+        )\n+\n \n class TestBatchingSiteRoot(TestBatchingDXBase):\n \n'

