Repository: plone.schemaeditor


Branch: refs/heads/master
Date: 2020-03-20T14:50:53+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.schemaeditor/commit/555e777216498a48722e05e428cd739b20326254

make work with zope.interface &gt;= 5

Files changed:
A news/75.bugfix
M plone/schemaeditor/utils.py

b'diff --git a/news/75.bugfix b/news/75.bugfix\nnew file mode 100644\nindex 0000000..6ac78cc\n--- /dev/null\n+++ b/news/75.bugfix\n@@ -0,0 +1 @@\n+Support zope.interface >= 5. [jensens]\ndiff --git a/plone/schemaeditor/utils.py b/plone/schemaeditor/utils.py\nindex 1fb052b..c804762 100644\n--- a/plone/schemaeditor/utils.py\n+++ b/plone/schemaeditor/utils.py\n@@ -8,6 +8,11 @@\n from zope.interface.interfaces import IInterface\n from zope.schema.interfaces import IField\n \n+import pkg_resources\n+\n+_zope_interface_version_major = int(\n+    pkg_resources.require(\'zope.interface\')[0].version.split(\'.\')[0]\n+)\n \n def sortedFields(schema):\n     """ Like getFieldsInOrder, but does not include fields from bases\n@@ -101,8 +106,11 @@ def addField(self, field, name=None):\n             )\n \n         self.schema._InterfaceClass__attrs[name] = field\n-        if hasattr(self.schema, \'_v_attrs\'):\n-            self.schema._v_attrs[name] = field\n+        if _zope_interface_version_major >= 5:\n+            self.schema._v_attrs = None\n+        else:\n+            if hasattr(self.schema, \'_v_attrs\'):\n+                self.schema._v_attrs[name] = field\n \n         field.interface = self.schema\n \n@@ -112,8 +120,11 @@ def removeField(self, field_name):\n         try:\n             self.schema[field_name].interface = None\n             del self.schema._InterfaceClass__attrs[field_name]\n-            if hasattr(self.schema, \'_v_attrs\'):\n-                del self.schema._v_attrs[field_name]\n+            if _zope_interface_version_major >= 5:\n+                self.schema._v_attrs = None\n+            else:\n+                if hasattr(self.schema, \'_v_attrs\'):\n+                    del self.schema._v_attrs[field_name]\n             for fieldset in self.schema.queryTaggedValue(FIELDSETS_KEY, []):\n                 if field_name in fieldset.fields:\n                     fieldset.fields.remove(field_name)\n'

Repository: plone.schemaeditor


Branch: refs/heads/master
Date: 2020-03-20T23:24:55+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.schemaeditor/commit/0fa9f7d301672de5e7ee63ebc63409a36e4fd934

Merge pull request #75 from plone/zope-interface-master

make work with zope.interface &gt;= 5

Files changed:
A news/75.bugfix
M plone/schemaeditor/utils.py

b'diff --git a/news/75.bugfix b/news/75.bugfix\nnew file mode 100644\nindex 0000000..6ac78cc\n--- /dev/null\n+++ b/news/75.bugfix\n@@ -0,0 +1 @@\n+Support zope.interface >= 5. [jensens]\ndiff --git a/plone/schemaeditor/utils.py b/plone/schemaeditor/utils.py\nindex 1fb052b..c804762 100644\n--- a/plone/schemaeditor/utils.py\n+++ b/plone/schemaeditor/utils.py\n@@ -8,6 +8,11 @@\n from zope.interface.interfaces import IInterface\n from zope.schema.interfaces import IField\n \n+import pkg_resources\n+\n+_zope_interface_version_major = int(\n+    pkg_resources.require(\'zope.interface\')[0].version.split(\'.\')[0]\n+)\n \n def sortedFields(schema):\n     """ Like getFieldsInOrder, but does not include fields from bases\n@@ -101,8 +106,11 @@ def addField(self, field, name=None):\n             )\n \n         self.schema._InterfaceClass__attrs[name] = field\n-        if hasattr(self.schema, \'_v_attrs\'):\n-            self.schema._v_attrs[name] = field\n+        if _zope_interface_version_major >= 5:\n+            self.schema._v_attrs = None\n+        else:\n+            if hasattr(self.schema, \'_v_attrs\'):\n+                self.schema._v_attrs[name] = field\n \n         field.interface = self.schema\n \n@@ -112,8 +120,11 @@ def removeField(self, field_name):\n         try:\n             self.schema[field_name].interface = None\n             del self.schema._InterfaceClass__attrs[field_name]\n-            if hasattr(self.schema, \'_v_attrs\'):\n-                del self.schema._v_attrs[field_name]\n+            if _zope_interface_version_major >= 5:\n+                self.schema._v_attrs = None\n+            else:\n+                if hasattr(self.schema, \'_v_attrs\'):\n+                    del self.schema._v_attrs[field_name]\n             for fieldset in self.schema.queryTaggedValue(FIELDSETS_KEY, []):\n                 if field_name in fieldset.fields:\n                     fieldset.fields.remove(field_name)\n'

