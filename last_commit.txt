Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-28T14:31:20+01:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/6364b29c31773c8dc4bb96d7b0c88baab7caa199

relstorage w/ sqlite

Files changed:
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt
M src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt

b'diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex dacfab0..b79c892 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -475,13 +475,24 @@ def is_rs_option(name):\n                 # All generic RelStorage options have a dash in their name,\n                 # except the "name" option. Other options are\n                 # database-specific.\n+                if name == \'data-dir\':  # sqlite3\n+                    return False\n                 return \'-\' in name or name == \'name\'\n \n+            db_opts = \'\\n\'.join(\' \' * 12 + \' \'.join((k, v))\n+                                for k, v in rel_storage.items()\n+                                if not is_rs_option(k))\n+            if type_ == \'sqlite3\':\n+                pragmas = [k for k in rel_storage if k.startswith(\'pragmas-\')]\n+                if pragmas:\n+                    db_opts += \'\\n\' + \' \' * 12 + \'<pragmas>\\n\'\n+                    for k in pragmas:\n+                        db_opts += \' \' * 16 + \' \'.join((k[8:], rel_storage[k])) + \'\\n\'\n+                        del rel_storage[k]\n+                    db_opts += \' \' * 12 + \'</pragmas>\\n\'\n             opts = dict(\n                 type=type_,\n-                db_opts=\'\\n\'.join(\' \' * 12 + \' \'.join((k, v))\n-                                  for k, v in rel_storage.items()\n-                                  if not is_rs_option(k)),\n+                db_opts=db_opts,\n                 rs_opts=\'\\n\'.join(\' \' * 8 + \' \'.join((k, v))\n                                   for k, v in rel_storage.items()\n                                   if is_rs_option(k)),\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 3cbd660..3b4bbd1 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -789,6 +789,57 @@ We should have a zope instance, with a basic zope.conf::\n     ...\n     <BLANKLINE>\n \n+Relstorage and sqlite3::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... wsgi = off\n+    ... eggs =\n+    ... user = me:me\n+    ... rel-storage =\n+    ...   type sqlite3\n+    ...   data-dir %(sample_buildout)s/var/db\n+    ...   pragmas-synchronous off\n+    ...   pragmas-checkpoint_fullfsync off\n+    ... \'\'\' % options)\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    <zodb_db main>\n+        # Main database\n+        cache-size 30000\n+    %import relstorage\n+        <relstorage>\n+            keep-history false\n+            <sqlite3>\n+                data-dir .../sample-buildout/var/db\n+                <pragmas>\n+                    synchronous off\n+                    checkpoint_fullfsync off\n+                </pragmas>\n+            </sqlite3>\n+        </relstorage>\n+        mount-point /\n+    </zodb_db>\n+    ...\n+    <BLANKLINE>\n+\n ZEO storage\n ===========\n \ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt b/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\nindex caef702..51921db 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\n@@ -2150,4 +2150,3 @@ script::\n     >>> instance = open(os.path.join(sample_buildout, \'bin\', \'instance\')).read()\n     >>> "print(\'Initialization complete!\')" in instance\n     True\n-\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-28T14:38:16+01:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/17e5745a5349f254f8753da692162c634e4e788e

changelog

Files changed:
A news/132.feature

b'diff --git a/news/132.feature b/news/132.feature\nnew file mode 100644\nindex 0000000..0aff2ea\n--- /dev/null\n+++ b/news/132.feature\n@@ -0,0 +1,2 @@\n+- added relstorage w/ sqlite support\n+  [mamico]\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-29T16:34:40+01:00
Author: Mauro Amico (mamico) <mauro.amico@gmail.com>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/35c96830524f1d3a711f091c5af87527969e7b2e

fix tests

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 3b4bbd1..55c957d 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -824,9 +824,8 @@ Relstorage and sqlite3::\n     <zodb_db main>\n         # Main database\n         cache-size 30000\n-    %import relstorage\n+        %import relstorage\n         <relstorage>\n-            keep-history false\n             <sqlite3>\n                 data-dir .../sample-buildout/var/db\n                 <pragmas>\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-29T16:50:23+01:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/04d59b5ad20a98eab78f91e81034a49b352dd2ff

flake8

Files changed:
M src/plone/recipe/zope2instance/recipe.py

b"diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex b79c892..04a3596 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -487,7 +487,8 @@ def is_rs_option(name):\n                 if pragmas:\n                     db_opts += '\\n' + ' ' * 12 + '<pragmas>\\n'\n                     for k in pragmas:\n-                        db_opts += ' ' * 16 + ' '.join((k[8:], rel_storage[k])) + '\\n'\n+                        db_opts += ' ' * 16 + \\\n+                            ' '.join((k[8:], rel_storage[k])) + '\\n'\n                         del rel_storage[k]\n                     db_opts += ' ' * 12 + '</pragmas>\\n'\n             opts = dict(\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-29T17:01:20+01:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/8b773a095a09e62f33d100c842c7a56c54819425

make tests happy

Files changed:
M src/plone/recipe/zope2instance/recipe.py

b"diff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex 04a3596..1bda5ed 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -486,7 +486,7 @@ def is_rs_option(name):\n                 pragmas = [k for k in rel_storage if k.startswith('pragmas-')]\n                 if pragmas:\n                     db_opts += '\\n' + ' ' * 12 + '<pragmas>\\n'\n-                    for k in pragmas:\n+                    for k in sorted(pragmas):\n                         db_opts += ' ' * 16 + \\\n                             ' '.join((k[8:], rel_storage[k])) + '\\n'\n                         del rel_storage[k]\n"

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-01-29T17:35:19+01:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/b17040a5c77dfcaa93b9f6b303b3037f2a0bc95c

sort pragmas directives (fix tests)

Files changed:
M src/plone/recipe/zope2instance/tests/zope2instance.txt

b'diff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 55c957d..bb9dd49 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -829,8 +829,8 @@ Relstorage and sqlite3::\n             <sqlite3>\n                 data-dir .../sample-buildout/var/db\n                 <pragmas>\n-                    synchronous off\n                     checkpoint_fullfsync off\n+                    synchronous off\n                 </pragmas>\n             </sqlite3>\n         </relstorage>\n'

Repository: plone.recipe.zope2instance


Branch: refs/heads/master
Date: 2020-02-24T15:46:38+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.recipe.zope2instance/commit/1ed93314c5b7e59f18e287c57aea218a6abae6fb

Merge pull request #132 from plone/relstorage-sqlite

relstorage w/ sqlite support

Files changed:
A news/132.feature
M src/plone/recipe/zope2instance/recipe.py
M src/plone/recipe/zope2instance/tests/zope2instance.txt
M src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt

b'diff --git a/news/132.feature b/news/132.feature\nnew file mode 100644\nindex 0000000..0aff2ea\n--- /dev/null\n+++ b/news/132.feature\n@@ -0,0 +1,2 @@\n+- added relstorage w/ sqlite support\n+  [mamico]\ndiff --git a/src/plone/recipe/zope2instance/recipe.py b/src/plone/recipe/zope2instance/recipe.py\nindex a7e8739..446b337 100644\n--- a/src/plone/recipe/zope2instance/recipe.py\n+++ b/src/plone/recipe/zope2instance/recipe.py\n@@ -476,13 +476,25 @@ def is_rs_option(name):\n                 # All generic RelStorage options have a dash in their name,\n                 # except the "name" option. Other options are\n                 # database-specific.\n+                if name == \'data-dir\':  # sqlite3\n+                    return False\n                 return \'-\' in name or name == \'name\'\n \n+            db_opts = \'\\n\'.join(\' \' * 12 + \' \'.join((k, v))\n+                                for k, v in rel_storage.items()\n+                                if not is_rs_option(k))\n+            if type_ == \'sqlite3\':\n+                pragmas = [k for k in rel_storage if k.startswith(\'pragmas-\')]\n+                if pragmas:\n+                    db_opts += \'\\n\' + \' \' * 12 + \'<pragmas>\\n\'\n+                    for k in sorted(pragmas):\n+                        db_opts += \' \' * 16 + \\\n+                            \' \'.join((k[8:], rel_storage[k])) + \'\\n\'\n+                        del rel_storage[k]\n+                    db_opts += \' \' * 12 + \'</pragmas>\\n\'\n             opts = dict(\n                 type=type_,\n-                db_opts=\'\\n\'.join(\' \' * 12 + \' \'.join((k, v))\n-                                  for k, v in rel_storage.items()\n-                                  if not is_rs_option(k)),\n+                db_opts=db_opts,\n                 rs_opts=\'\\n\'.join(\' \' * 8 + \' \'.join((k, v))\n                                   for k, v in rel_storage.items()\n                                   if is_rs_option(k)),\ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance.txt b/src/plone/recipe/zope2instance/tests/zope2instance.txt\nindex 97ae20d..891049c 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance.txt\n@@ -789,6 +789,56 @@ We should have a zope instance, with a basic zope.conf::\n     ...\n     <BLANKLINE>\n \n+Relstorage and sqlite3::\n+\n+    >>> write(\'buildout.cfg\',\n+    ... \'\'\'\n+    ... [buildout]\n+    ... parts = instance\n+    ... find-links = %(sample_buildout)s/eggs\n+    ...\n+    ... [instance]\n+    ... recipe = plone.recipe.zope2instance\n+    ... wsgi = off\n+    ... eggs =\n+    ... user = me:me\n+    ... rel-storage =\n+    ...   type sqlite3\n+    ...   data-dir %(sample_buildout)s/var/db\n+    ...   pragmas-synchronous off\n+    ...   pragmas-checkpoint_fullfsync off\n+    ... \'\'\' % options)\n+\n+    >>> print(system(join(\'bin\', \'buildout\'))),\n+    Uninstalling instance.\n+    Installing instance.\n+    Generated script \'...instance\'.\n+    Generated interpreter \'.../parts/instance/bin/interpreter\'...\n+\n+    >>> instance = os.path.join(sample_buildout, \'parts\', \'instance\')\n+    >>> zope_conf = open(os.path.join(instance, \'etc\', \'zope.conf\')).read()\n+    >>> zope_conf = zope_conf.replace(\'\\\\\', \'/\')\n+    >>> print(zope_conf)\n+    %define INSTANCEHOME .../sample-buildout/parts/instance\n+    ...\n+    <zodb_db main>\n+        # Main database\n+        cache-size 30000\n+        %import relstorage\n+        <relstorage>\n+            <sqlite3>\n+                data-dir .../sample-buildout/var/db\n+                <pragmas>\n+                    checkpoint_fullfsync off\n+                    synchronous off\n+                </pragmas>\n+            </sqlite3>\n+        </relstorage>\n+        mount-point /\n+    </zodb_db>\n+    ...\n+    <BLANKLINE>\n+\n ZEO storage\n ===========\n \ndiff --git a/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt b/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\nindex caef702..51921db 100644\n--- a/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\n+++ b/src/plone/recipe/zope2instance/tests/zope2instance_zserver.txt\n@@ -2150,4 +2150,3 @@ script::\n     >>> instance = open(os.path.join(sample_buildout, \'bin\', \'instance\')).read()\n     >>> "print(\'Initialization complete!\')" in instance\n     True\n-\n'

