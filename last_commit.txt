Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-02-25T14:54:29+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/2f71b68ec99bf06e68a54249c027ded8999de282

Fixed TypeError when adding both a group and a user to a group.

Fixes https://github.com/plone/Products.CMFPlone/issues/3048

Files changed:
A news/3084.bugfix
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\nindex d41793362a..5720cbd01c 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n@@ -83,16 +83,21 @@ def isGroup(self, itemName):\n     def getMembers(self):\n         searchResults = self.gtool.getGroupMembers(self.groupname)\n \n-        groupResults = [self.gtool.getGroupById(m) for m in searchResults]\n-        groupResults.sort(key=lambda x: x is not None and normalizeString(\n-            x.getGroupTitleOrName()))\n-\n-        userResults = [self.mtool.getMemberById(m) for m in searchResults]\n-        userResults.sort(key=lambda x: x is not None and x.getProperty(\n-            \'fullname\') is not None and normalizeString(x.getProperty(\'fullname\')) or \'\')\n-\n-        mergedResults = groupResults + userResults\n-        return [i for i in mergedResults if i]\n+        groupResults = []\n+        userResults = []\n+        for principal_id in searchResults:\n+            principal = self.gtool.getGroupById(principal_id)\n+            if principal is not None:\n+                groupResults.append(principal)\n+                continue\n+            principal = self.mtool.getMemberById(principal_id)\n+            if principal is not None:\n+                userResults.append(principal)\n+\n+        groupResults.sort(key=lambda x: normalizeString(x.getGroupTitleOrName()))\n+        userResults.sort(key=lambda x: normalizeString(x.getProperty(\'fullname\') or \'\'))\n+\n+        return groupResults + userResults\n \n     def getPotentialMembers(self, searchString):\n         ignoredUsersGroups = [\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\nindex 6376fadd8f..b8af1888bf 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n@@ -370,6 +370,22 @@ def test_group_add_group(self):\n             \'Add selected groups and users to this group\').click()\n         self.assertIn(\'Group 2\', self.browser.contents)\n \n+        # Check that you can still add a user too.  This failed at some point:\n+        # https://github.com/plone/Products.CMFPlone/issues/3048\n+        # Add user (Autumn Brooks) to selected group (Group 1)\n+        self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n+        self.browser.getControl(name=\'form.button.Search\').click()\n+        self.browser.getControl(name=\'add:list\').getControl(\n+            value=\'TWrMCLIo\').selected = True\n+        self.browser.getControl(\n+            \'Add selected groups and users to this group\').click()\n+\n+        # Check that both group and user are now part of the group\n+        self.browser.open(self.groups_url)\n+        self.browser.getLink(\'Group 1 (group1)\').click()\n+        self.assertIn(\'Autumn Brooks\', self.browser.contents)\n+        self.assertIn(\'Group 2\', self.browser.contents)\n+\n     def test_usergroups_settings_many_users(self):\n         self.browser.open("%s/@@usergroup-controlpanel" % self.portal_url)\n         self.browser.getControl(\ndiff --git a/news/3084.bugfix b/news/3084.bugfix\nnew file mode 100644\nindex 0000000000..a223513a84\n--- /dev/null\n+++ b/news/3084.bugfix\n@@ -0,0 +1,2 @@\n+Fixed TypeError when adding both a group and a user to a group.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-02-26T16:54:26+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/Products.CMFPlone/commit/8ac3b1f11a67d03e9b4d6981bf7c48361a703e1b

Merge pull request #3054 from plone/maurits/issue-3048-add-user-and-group-52

Fixed TypeError when adding both a group and a user to a group. [5.2]

Files changed:
A news/3084.bugfix
M Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\nindex d41793362a..5720cbd01c 100644\n--- a/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n+++ b/Products/CMFPlone/controlpanel/browser/usergroups_groupmembership.py\n@@ -83,16 +83,21 @@ def isGroup(self, itemName):\n     def getMembers(self):\n         searchResults = self.gtool.getGroupMembers(self.groupname)\n \n-        groupResults = [self.gtool.getGroupById(m) for m in searchResults]\n-        groupResults.sort(key=lambda x: x is not None and normalizeString(\n-            x.getGroupTitleOrName()))\n-\n-        userResults = [self.mtool.getMemberById(m) for m in searchResults]\n-        userResults.sort(key=lambda x: x is not None and x.getProperty(\n-            \'fullname\') is not None and normalizeString(x.getProperty(\'fullname\')) or \'\')\n-\n-        mergedResults = groupResults + userResults\n-        return [i for i in mergedResults if i]\n+        groupResults = []\n+        userResults = []\n+        for principal_id in searchResults:\n+            principal = self.gtool.getGroupById(principal_id)\n+            if principal is not None:\n+                groupResults.append(principal)\n+                continue\n+            principal = self.mtool.getMemberById(principal_id)\n+            if principal is not None:\n+                userResults.append(principal)\n+\n+        groupResults.sort(key=lambda x: normalizeString(x.getGroupTitleOrName()))\n+        userResults.sort(key=lambda x: normalizeString(x.getProperty(\'fullname\') or \'\'))\n+\n+        return groupResults + userResults\n \n     def getPotentialMembers(self, searchString):\n         ignoredUsersGroups = [\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\nindex 6376fadd8f..b8af1888bf 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_usergroups.py\n@@ -370,6 +370,22 @@ def test_group_add_group(self):\n             \'Add selected groups and users to this group\').click()\n         self.assertIn(\'Group 2\', self.browser.contents)\n \n+        # Check that you can still add a user too.  This failed at some point:\n+        # https://github.com/plone/Products.CMFPlone/issues/3048\n+        # Add user (Autumn Brooks) to selected group (Group 1)\n+        self.browser.getControl(name=\'searchstring\').value = \'TWrMCLIo\'\n+        self.browser.getControl(name=\'form.button.Search\').click()\n+        self.browser.getControl(name=\'add:list\').getControl(\n+            value=\'TWrMCLIo\').selected = True\n+        self.browser.getControl(\n+            \'Add selected groups and users to this group\').click()\n+\n+        # Check that both group and user are now part of the group\n+        self.browser.open(self.groups_url)\n+        self.browser.getLink(\'Group 1 (group1)\').click()\n+        self.assertIn(\'Autumn Brooks\', self.browser.contents)\n+        self.assertIn(\'Group 2\', self.browser.contents)\n+\n     def test_usergroups_settings_many_users(self):\n         self.browser.open("%s/@@usergroup-controlpanel" % self.portal_url)\n         self.browser.getControl(\ndiff --git a/news/3084.bugfix b/news/3084.bugfix\nnew file mode 100644\nindex 0000000000..a223513a84\n--- /dev/null\n+++ b/news/3084.bugfix\n@@ -0,0 +1,2 @@\n+Fixed TypeError when adding both a group and a user to a group.\n+[maurits]\n'

