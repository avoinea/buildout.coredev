Repository: plone.rest


Branch: refs/heads/master
Date: 2020-03-22T21:02:18+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.rest/commit/1853a1ef42533c39ea812c6cb03c7ae875412246

CORS preflight should happen for all error codes (#102)

Co-authored-by: Timo Stollenwerk &lt;stollenwerk@kitconcept.com&gt;

Files changed:
A news/101.bugfix
M src/plone/rest/errors.py

b'diff --git a/news/101.bugfix b/news/101.bugfix\nnew file mode 100644\nindex 0000000..e334957\n--- /dev/null\n+++ b/news/101.bugfix\n@@ -0,0 +1,2 @@\n+CORS preflight should happen for all error codes, fixes #101\n+[sneridagh]\ndiff --git a/src/plone/rest/errors.py b/src/plone/rest/errors.py\nindex bb2a67c..1eed12b 100644\n--- a/src/plone/rest/errors.py\n+++ b/src/plone/rest/errors.py\n@@ -6,6 +6,7 @@\n     IRedirectionStorage = None\n from plone.memoize.instance import memoize\n from plone.rest.interfaces import IAPIRequest\n+from plone.rest.interfaces import ICORSPolicy\n from Products.CMFCore.permissions import ManagePortal\n from Products.Five.browser import BrowserView\n from six.moves import urllib\n@@ -20,6 +21,7 @@\n except ImportError:\n     HAS_WSGI = False\n from zope.component import adapter\n+from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n from zope.component.hooks import getSite\n \n@@ -61,6 +63,10 @@ def render_exception(self, exception):\n             message = message.decode("utf-8")\n         result = {u"type": name, u"message": message}\n \n+        policy = queryMultiAdapter((self.context, self.request), ICORSPolicy)\n+        if policy is not None:\n+            policy.process_simple_request()\n+\n         if isinstance(exception, NotFound):\n             # First check if a redirect from p.a.redirector exists\n             redirect_performed = self.attempt_redirect()\n'

