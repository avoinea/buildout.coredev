Repository: plone.restapi


Branch: refs/heads/master
Date: 2020-03-03T18:40:22+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/8ca9df429333260cc5519dc37057bf6e7230cb32

Add a catalog serializer guard when returning fullobjects in case the object doesn't exist anymore because for some reason it failed to uncatalog itself. (#878)

Files changed:
A news/877.bugfix
M src/plone/restapi/serializer/catalog.py

b'diff --git a/news/877.bugfix b/news/877.bugfix\nnew file mode 100644\nindex 00000000..cb1d0fc1\n--- /dev/null\n+++ b/news/877.bugfix\n@@ -0,0 +1,3 @@\n+Add a catalog serializer guard when returning fullobjects in case the object doesn\'t\n+exist anymore because for some reason it failed to uncatalog itself.\n+[sneridagh]\ndiff --git a/src/plone/restapi/serializer/catalog.py b/src/plone/restapi/serializer/catalog.py\nindex e8506148..fb33d340 100644\n--- a/src/plone/restapi/serializer/catalog.py\n+++ b/src/plone/restapi/serializer/catalog.py\n@@ -8,6 +8,10 @@\n from zope.interface import implementer\n from zope.interface import Interface\n \n+import logging\n+\n+log = logging.getLogger(__name__)\n+\n \n @implementer(ISerializeToJson)\n @adapter(Lazy, Interface)\n@@ -33,9 +37,19 @@ def __call__(self, metadata_fields=(), fullobjects=False):\n         results["items"] = []\n         for brain in batch:\n             if fullobjects:\n-                result = getMultiAdapter(\n-                    (brain.getObject(), self.request), ISerializeToJson\n-                )(include_items=False)\n+                try:\n+                    result = getMultiAdapter(\n+                        (brain.getObject(), self.request), ISerializeToJson\n+                    )(include_items=False)\n+                except KeyError:\n+                    # Guard in case the brain returned refers to an object that doesn\'t\n+                    # exists because it failed to uncatalog itself or the catalog has\n+                    # stale cataloged objects for some reason\n+                    log.warn(\n+                        "Brain getObject error: {} doesn\'t exist anymore".format(\n+                            brain.getPath()\n+                        )\n+                    )\n             else:\n                 result = getMultiAdapter(\n                     (brain, self.request), ISerializeToJsonSummary\n'

